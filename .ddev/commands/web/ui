#!/bin/bash

## Description: Drupal Canvas: Build the UI code and run the dev server. Optionally install dependencies first, or skip the build step.
## Usage: ui [--install|-i] [--skip-build|-s]
## Example: "ddev ui" or "ddev ui --skip-build" or "ddev ui -s" or "ddev ui --install" or "ddev ui -i" or "ddev ui --install --skip-build"
## ExecRaw: true

# Parse command line arguments.
SKIP_BUILD_FLAG=false
INSTALL_FLAG=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --skip-build|-s)
            SKIP_BUILD_FLAG=true
            shift
            ;;
        --install|-i)
            INSTALL_FLAG=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: ui [--install|-i] [--skip-build|-s]"
            exit 1
            ;;
    esac
done

cd "$DDEV_COMPOSER_ROOT/web/modules/contrib/canvas/ui" || exit

if [ "$INSTALL_FLAG" = true ]; then
    npm install \
        --prefix "$DDEV_COMPOSER_ROOT/web/modules/contrib/canvas/ui" \
        || exit 1
fi

if [ "$SKIP_BUILD_FLAG" = false ]; then
    npm run build \
        --prefix "$DDEV_COMPOSER_ROOT/web/modules/contrib/canvas/ui" \
        || exit 1
fi

# Install canvas_vite so the dev server serves the UI assets instead.
drush pm:install canvas_vite -y 2>/dev/null

npm run drupaldev \
    --prefix "$DDEV_COMPOSER_ROOT/web/modules/contrib/canvas/ui" \
    -- --host
    || exit 1
